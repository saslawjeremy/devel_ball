#!/usr/bin/env python3.7

import pandas as pd
from argparse import ArgumentParser
import datetime
from mongoengine import connect
import pickle
import os
import pulp

from devel_ball.lineup_optimizer import optimize_lineup


if __name__ == '__main__':

    connect('devel_ball')

    parser = ArgumentParser()
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('--today', action='store_true', help='Predict today.')
    group.add_argument('--tomorrow', action='store_true', help='Predict tomorrow.')
    parser.add_argument(
        '--model', default='2021-22_model.p', help='Name for the model to use for prediction'
    )
    parser.add_argument('--ignore', default=[], nargs='*', help='Players to ignore when making lineup')
    parser.add_argument('--must-include', default=[], nargs='*', help='Players that must be included')
    parser.add_argument('--lineups', default=1, type=int, help="How many lineups to generate")
    parser.add_argument('--debug', action='store_true', help='Print chosen players unordered for debug')
    args = parser.parse_args()

    # Get data to predict on
    if args.today:
        data_name = "{}/predict/today.p".format(os.environ.get("DEVEL_BALL_DATA_PATH"))
    else:
        data_name = "{}/predict/tomorrow.p".format(os.environ.get("DEVEL_BALL_DATA_PATH"))
    dk_players, data = pd.read_pickle(data_name)

    # Load the relevant model
    model_name = "{}/{}".format(os.environ.get("DEVEL_BALL_MODELS_PATH"), args.model)
    model, data_pipeline = pickle.load(open(model_name, 'rb'))

    # Optimize lineup
    optimize_lineup(
        dk_players=dk_players,
        prediction_data=data,
        model=model,
        model_data_pipeline=data_pipeline,
        players_remove=args.ignore,
        players_add=args.must_include,
        lineups=args.lineups,
        debug=args.debug,
    )
